OTT_SOURCE = Qualitative
OTT_LOC    = ..
FILES      = Qualitative_ott Qualitative_inf
OTTFILES   = $(foreach i, $(OTT_SOURCE), $(OTT_LOC)/$(i).ott)
OTTIFLAGS  = $(foreach i, $(OTT_SOURCE), -i $(OTT_LOC)/$(i).ott)
OTTOFLAGS  = $(foreach i, $(OTT_SOURCE), -o $(i)_ott.v)

all: coq

################ latex ####################

SPEC = $(OTT_LOC)/$(OTT_SOURCE).ott
SPECFILE = spec.tex
RULESFILE = qualitative-rules.tex

spec.pdf: $(SPEC) $(SPECFILE)
	ott -o $(RULESFILE) \
					-tex_wrap false \
					-tex_show_meta false $(SPEC)
	pdflatex -interaction nonstopmode $(SPECFILE)
	mv spec.pdf ..


$(RULESFILE): $(SPEC)
	ott $(OTTIFLAGS) -o $(RULESFILE) \
					-tex_wrap false \
					-tex_show_meta false

%.tex: $(RULESFILE) %.mng Makefile
	ott $(OTTIFLAGS) \
										-tex_wrap false \
										-tex_show_meta false \
										-tex_filter $*.mng $*.tex

%.pdf : %.tex $(RULESFILE)
	latexmk -bibtex -pdf $*.tex



###################### COQ ##############################

## Paths to executables. Do not include options here.
## Modify these to suit your Coq installation, if necessary.

COQC = coqc
COQDEP = coqdep

LIBNAME=Qual
LNGEN=lngen

## Include directories, one per line.

INCDIRS = \
        . \
        $(METALIBLOCATION) \


## Library name used for the imports in Coq



## Name of the submakefile generated by coq_makefile
COQMKFILENAME=CoqSrc.mk

VFILES   = $(foreach i, $(FILES), $(i).v)
VOFILES  = $(foreach i, $(FILES), $(i).vo)
INCFLAGS = $(foreach i, $(INCDIRS), -I $(i))

.SECONDARY: $(VFILES)

METALIBFILES= $(METALIBLOCATION)/*.v  $(METALIBLOCATION)/Makefile  $(METALIBLOCATION)/README.txt


quick:  $(COQMKFILENAME)
	@$(MAKE) -f CoqSrc.mk quick


coq: $(COQMKFILENAME) $(VFILES) 
	@$(MAKE) -f CoqSrc.mk


%.vo: %.v
	@$(MAKE) -f CoqSrc.mk $*.vo


%_ott.v: $(OTT_LOC)/%.ott Makefile typing.patch
	ott $(OTTIFLAGS)  $(OTTOFLAGS) -coq_lngen true -coq_expand_list_types true
	make METALIB.FIX_$*_ott
	make PATCH_TYPING_$*_ott

%_inf.v: $(OTT_LOC)/%.ott Makefile 
	$(LNGEN) --coq-no-proofs --coq $*_inf.v --coq-ott $*_ott $(OTT_LOC)/$*.ott 
	make GRADE.FIX_$*_inf

%_inf_proofs.v: $(OTT_LOC)/%.ott Makefile
	$(LNGEN) --coq $*_inf_proofs.v --coq-ott $*_ott $(OTT_LOC)/$*.ott 


$(COQMKFILENAME): Makefile $(shell ls *.v | grep -v _ott.v | grep -v _inf.v)
	{ echo "-R . $(LIBNAME) " ; ls *.v ; } > _CoqProject && coq_makefile -arg '-w -variable-collision,-meta-collision,-require-in-module' -f _CoqProject -o $(COQMKFILENAME)


coqclean:
	@rm -if *.v.d *.vo *.glob *.v-e *.vok *.vos *.conf *.v-e $(VOFILES) $(COQMKFILENAME)

clean: coqclean
	@rm -f *~
	@rm -f *.log *.aux *.fls *.fdb_latexmk

METALIB.FIX_%:
	sed -i -e 's/Metalib.Metatheory./Metalib.Metatheory. Require Export Metalib.LibLNgen. Require Export Qual.grade_sig. /g' $*.v
	sed '1d' $*.v > __TMP__; mv __TMP__ $*.v

PATCH_TYPING_%:
	patch -R $*.v < typing.patch

# delete lines from _inf.v file corresponding to "grade".  Need to update this 
# when .ott file is changed
GRADE.FIX_%:
	sed '76,80d' $*.v | sed '18,29d' > __TMP__; mv __TMP__ $*.v
